<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sentinel | LinDocs</title>
    <meta name="description" content="Vite & Vue powered static site generator.">
    <link rel="preload stylesheet" href="/lindocs/assets/style.3f977174.css" as="style">
    <link rel="modulepreload" href="/lindocs/assets/chunks/VPAlgoliaSearchBox.565a6da9.js">
    <link rel="modulepreload" href="/lindocs/assets/app.9e1597b0.js">
    <link rel="modulepreload" href="/lindocs/assets/spring_springcloud_sentinel.md.4f75d99a.lean.js">
    
    <link rel="icon" href="./favicon.ico">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-8e0293cf data-v-2855b47a><!--[--><!--]--><!--[--><span tabindex="-1" data-v-59736647></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-59736647> Skip to content </a><!--]--><!----><header class="VPNav" data-v-2855b47a data-v-c96f2c5c><div class="VPNavBar has-sidebar" data-v-c96f2c5c data-v-fffd92b9><div class="container" data-v-fffd92b9><div class="VPNavBarTitle has-sidebar" data-v-fffd92b9 data-v-cca63090><a class="title" href="/lindocs/" data-v-cca63090><!--[--><!--]--><!----><!--[-->LinDocs<!--]--><!--[--><!--]--></a></div><div class="content" data-v-fffd92b9><!--[--><!--]--><div class="VPNavBarSearch search" data-v-fffd92b9 style="--65f62738:&#39;Meta&#39;;"><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-fffd92b9 data-v-28f09fbf><span id="main-nav-aria-label" class="visually-hidden" data-v-28f09fbf>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/lindocs/frontend/js/" data-v-28f09fbf data-v-985a9e89 data-v-87c72c21><!--[-->🎉前端<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/lindocs/database/mysql/mysql-base.html" data-v-28f09fbf data-v-985a9e89 data-v-87c72c21><!--[-->🔥数据库<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/lindocs/java/java-base.html" data-v-28f09fbf data-v-985a9e89 data-v-87c72c21><!--[-->🔥JAVA<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/lindocs/spring/springcloud/SpringCloud.html" data-v-28f09fbf data-v-985a9e89 data-v-87c72c21><!--[-->🥳spring<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/lindocs/kotlin/" data-v-28f09fbf data-v-985a9e89 data-v-87c72c21><!--[-->🥳kotlin<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/lindocs/network/IPV6.html" data-v-28f09fbf data-v-985a9e89 data-v-87c72c21><!--[-->network<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-fffd92b9 data-v-43fbcba2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-43fbcba2 data-v-3e5b53af data-v-4ca06f51><span class="check" data-v-4ca06f51><span class="icon" data-v-4ca06f51><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3e5b53af><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3e5b53af><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-fffd92b9 data-v-d03627c8 data-v-1b5b2373><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-1b5b2373><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-1b5b2373><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-1b5b2373><div class="VPMenu" data-v-1b5b2373 data-v-09926e5f><!----><!--[--><!--[--><!----><div class="group" data-v-d03627c8><div class="item appearance" data-v-d03627c8><p class="label" data-v-d03627c8>Appearance</p><div class="appearance-action" data-v-d03627c8><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-d03627c8 data-v-3e5b53af data-v-4ca06f51><span class="check" data-v-4ca06f51><span class="icon" data-v-4ca06f51><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3e5b53af><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3e5b53af><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-fffd92b9 data-v-5dea55bf><span class="container" data-v-5dea55bf><span class="top" data-v-5dea55bf></span><span class="middle" data-v-5dea55bf></span><span class="bottom" data-v-5dea55bf></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-2855b47a data-v-54fccb40><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-54fccb40><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-54fccb40><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-54fccb40>Menu</span></button><a class="top-link" href="#" data-v-54fccb40> Return to top </a></div><aside class="VPSidebar" data-v-2855b47a data-v-284e079d><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-284e079d><span class="visually-hidden" id="sidebar-aria-label" data-v-284e079d> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-284e079d><section class="VPSidebarGroup" data-v-284e079d data-v-3f16556a><div class="title" data-v-3f16556a><h2 class="title-text" data-v-3f16556a>springcloud</h2><div class="action" data-v-3f16556a><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-3f16556a><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-3f16556a><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-3f16556a><!--[--><!--[--><a class="VPLink link link" href="/lindocs/spring/springcloud/SpringCloud.html" style="padding-left:0px;" tabindex="-1" data-v-a61ef70d data-v-87c72c21><!--[--><span class="link-text" data-v-a61ef70d>SpringCloud</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/lindocs/spring/springcloud/nacos.html" style="padding-left:0px;" tabindex="-1" data-v-a61ef70d data-v-87c72c21><!--[--><span class="link-text" data-v-a61ef70d>nacos</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link active" href="/lindocs/spring/springcloud/sentinel.html" style="padding-left:0px;" tabindex="-1" data-v-a61ef70d data-v-87c72c21><!--[--><span class="link-text" data-v-a61ef70d>sentinel</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/lindocs/spring/springcloud/springcloudgateway.html" style="padding-left:0px;" tabindex="-1" data-v-a61ef70d data-v-87c72c21><!--[--><span class="link-text" data-v-a61ef70d>gateway</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><div class="group" data-v-284e079d><section class="VPSidebarGroup" data-v-284e079d data-v-3f16556a><div class="title" data-v-3f16556a><h2 class="title-text" data-v-3f16556a>springboot</h2><div class="action" data-v-3f16556a><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-3f16556a><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-3f16556a><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-3f16556a><!--[--><!--[--><a class="VPLink link link" href="/lindocs/spring/springboot/SpringBoot.html" style="padding-left:0px;" tabindex="-1" data-v-a61ef70d data-v-87c72c21><!--[--><span class="link-text" data-v-a61ef70d>springboot</span><!--]--><!----></a><!----><!--]--><!--[--><a class="VPLink link link" href="/lindocs/spring/springboot/rabbitMQ.html" style="padding-left:0px;" tabindex="-1" data-v-a61ef70d data-v-87c72c21><!--[--><span class="link-text" data-v-a61ef70d>rabbitMQ</span><!--]--><!----></a><!----><!--]--><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-2855b47a data-v-a4e4f0b2><div class="VPDoc has-sidebar has-aside" data-v-a4e4f0b2 data-v-22d94e81><div class="container" data-v-22d94e81><div class="aside" data-v-22d94e81><div class="aside-curtain" data-v-22d94e81></div><div class="aside-container" data-v-22d94e81><div class="aside-content" data-v-22d94e81><div class="VPDocAside" data-v-22d94e81 data-v-8efc4ac7><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-8efc4ac7 data-v-a094936b><div class="content" data-v-a094936b><div class="outline-marker" data-v-a094936b></div><div class="outline-title" data-v-a094936b>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-a094936b><span class="visually-hidden" id="doc-outline-aria-label" data-v-a094936b> Table of Contents for current page </span><ul class="root" data-v-a094936b data-v-c6ed8bb7><!--[--><!--]--></ul></nav></div></div><!--[--><!--[--><!--[--><!--[--><div class="recommend-container" data-v-8e0293cf><p data-v-8e0293cf>扫码联系</p><p class="item-desc" data-v-8e0293cf>IT 咨询 &amp; 一起学习</p><img src="http://cdn.azhiyuan.com.cn/markdown/img/6593924985b60756ef48c391e43d48a.png" alt="前端" data-v-8e0293cf></div><!--]--><!--]--><!--]--><!--]--><div class="spacer" data-v-8efc4ac7></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-22d94e81><div class="content-container" data-v-22d94e81><!--[--><!--]--><main class="main" data-v-22d94e81><div style="position:relative;" class="vp-doc _lindocs_spring_springcloud_sentinel" data-v-22d94e81><div><h1 id="sentinel" tabindex="-1">Sentinel <a class="header-anchor" href="#sentinel" aria-hidden="true">#</a></h1><h2 id="初识-sentinel" tabindex="-1">初识 Sentinel <a class="header-anchor" href="#初识-sentinel" aria-hidden="true">#</a></h2><h3 id="初识sentinel" tabindex="-1">初识Sentinel <a class="header-anchor" href="#初识sentinel" aria-hidden="true">#</a></h3><p>Sentinel是阿里巴巴开源的一款微服务流量控制组件。<a href="https://sentinelguard.io/zh-cn/index.html" target="_blank" rel="noreferrer">官网地址</a></p><p>Sentinel 具有以下特征:</p><ul><li><p><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</p></li><li><p><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</p></li><li><p><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</p></li><li><p><strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p></li></ul><h3 id="安装sentinel" tabindex="-1">安装Sentinel <a class="header-anchor" href="#安装sentinel" aria-hidden="true">#</a></h3><ol><li>下载</li></ol><p>sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noreferrer">GitHub</a>下载。</p><ol start="2"><li>运行</li></ol><p>将jar包放到任意非中文目录，执行命令：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FFA657;">java</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">-jar</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">sentinel-dashboard-1.8.1.jar</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：</p><table><thead><tr><th><strong>配置项</strong></th><th><strong>默认值</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>server.port</td><td>8080</td><td>服务端口</td></tr><tr><td>sentinel.dashboard.auth.username</td><td>sentinel</td><td>默认用户名</td></tr><tr><td>sentinel.dashboard.auth.password</td><td>sentinel</td><td>默认密码</td></tr></tbody></table><p>例如，修改端口：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FFA657;">java</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">-Dserver.port=8090</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">-jar</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">sentinel-dashboard-1.8.1.jar</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>3）访问</p><p>访问<code>http://localhost:8080</code>页面，就可以看到sentinel的控制台了：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113183309.png" alt="image-20210715190827846"></p><p>需要输入账号和密码，默认都是：sentinel</p><p>登录后，发现一片空白，什么都没有：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113183312.png" alt="image-20210715191134448"></p><p>这是因为我们还没有与微服务整合。</p><h3 id="微服务整合sentinel" tabindex="-1">微服务整合Sentinel <a class="header-anchor" href="#微服务整合sentinel" aria-hidden="true">#</a></h3><p>我们在service中整合sentinel，并连接sentinel的控制台，步骤如下：</p><ol><li>引入sentinel依赖</li></ol><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#8B949E;">&lt;!--sentinel--&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;com.alibaba.cloud&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt; </span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;spring-cloud-starter-alibaba-sentinel&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>配置控制台</li></ol><p>修改<code>application.yaml</code>文件，添加下面内容：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">server</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">port</span><span style="color:#C9D1D9;">: </span><span style="color:#79C0FF;">8088</span></span>
<span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">: </span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">sentinel</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">transport</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#7EE787;">dashboard</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">localhost:8080</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="流量控制" tabindex="-1">流量控制 <a class="header-anchor" href="#流量控制" aria-hidden="true">#</a></h2><h3 id="流控模式" tabindex="-1">流控模式 <a class="header-anchor" href="#流控模式" aria-hidden="true">#</a></h3><p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p><ul><li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li><li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li><li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li></ul><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184052.png" alt="image-20210715201827886"></p><h4 id="关联模式" tabindex="-1">关联模式 <a class="header-anchor" href="#关联模式" aria-hidden="true">#</a></h4><p><strong>关联模式</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p><p><strong>配置规则</strong>：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184055.png" alt="image-20210715202540786"></p><p><strong>语法说明</strong>：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。</p><p><strong>使用场景</strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p><h4 id="链路模式" tabindex="-1">链路模式 <a class="header-anchor" href="#链路模式" aria-hidden="true">#</a></h4><p><strong>链路模式</strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p><p><strong>配置示例</strong>：</p><p>例如有两条请求链路：</p><ul><li><p>/test1 --&gt; /common</p></li><li><p>/test2 --&gt; /common</p></li></ul><p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184126.png" alt="image-20210716103536346"></p><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p><p>我们需要关闭这种对SpringMVC的资源聚合，修改service服务的application.yml文件：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">sentinel</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">web-context-unify</span><span style="color:#C9D1D9;">: </span><span style="color:#79C0FF;">false</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;"># 关闭context整合</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="流控效果" tabindex="-1">流控效果 <a class="header-anchor" href="#流控效果" aria-hidden="true">#</a></h3><p>在流控的高级选项中，还有一个流控效果选项：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184619.png" alt="image-20210716110225104"></p><p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p><ul><li><p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</p></li><li><p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</p></li><li><p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p></li></ul><h4 id="warm-up" tabindex="-1">warm up <a class="header-anchor" href="#warm-up" aria-hidden="true">#</a></h4><p>阈值一般是一个微服务能承担的最大QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。</p><p>warm up也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而coldFactor的默认值是3.</p><p>例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，然后在5秒后逐渐增长到10.</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184625.png" alt="image-20210716110629796"></p><h4 id="排队等待" tabindex="-1">排队等待 <a class="header-anchor" href="#排队等待" aria-hidden="true">#</a></h4><p>当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。</p><p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p><p>工作原理</p><p>例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着<strong>预期等待时长</strong>超过2000ms的请求会被拒绝并抛出异常。</p><p>那什么叫做预期等待时长呢？</p><p>比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：</p><ul><li>第6个请求的<strong>预期等待时长</strong> = 200 * （6 - 1） = 1000ms</li><li>第12个请求的预期等待时长 = 200 * （12-1） = 2200ms</li></ul><p>现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184629.png" alt="image-20210716113147176"></p><p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，QPS会变的很平滑：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184631.png" alt="image-20210716113426524"></p><p>平滑的QPS曲线，对于服务器来说是更友好的。</p><h3 id="热点参数限流" tabindex="-1">热点参数限流 <a class="header-anchor" href="#热点参数限流" aria-hidden="true">#</a></h3><p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p><h4 id="全局参数限流" tabindex="-1">全局参数限流 <a class="header-anchor" href="#全局参数限流" aria-hidden="true">#</a></h4><p>例如，一个根据id查询商品的接口：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184634.png" alt="image-20210716115014663"></p><p>访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184639.png" alt="image-20210716115131463"></p><p>当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。</p><p>配置示例：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184721.png" alt="image-20210716115232426"></p><p>代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒<strong>相同参数值</strong>的请求数不能超过5.</p><h4 id="热点参数限流-1" tabindex="-1">热点参数限流 <a class="header-anchor" href="#热点参数限流-1" aria-hidden="true">#</a></h4><p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.</p><p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184724.png" alt="image-20210716115717523"></p><p>结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：</p><p>•如果参数值是100，则每1秒允许的QPS为10</p><p>•如果参数值是101，则每1秒允许的QPS为15</p><h2 id="隔离和降级" tabindex="-1">隔离和降级 <a class="header-anchor" href="#隔离和降级" aria-hidden="true">#</a></h2><blockquote><p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。 而要将这些故障控制在一定范围，避免雪崩，就要靠<code>线程隔离</code>（舱壁模式）和<code>熔断降级</code>手段了。</p></blockquote><p><code>线程隔离</code>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184902.png" alt="image-20210715173215243"></p><p><strong>熔断降级</strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113184905.png" alt="image-20210715173428073"></p><p>可以看到，不管是线程隔离还是熔断降级，都是对<code>客户端</code>（调用方）的保护。需要在<code>调用方</code> 发起远程调用时做线程隔离、或者服务熔断。</p><p>而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</p><h3 id="feignclient整合sentinel" tabindex="-1">FeignClient整合Sentinel <a class="header-anchor" href="#feignclient整合sentinel" aria-hidden="true">#</a></h3><blockquote><p>SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。</p></blockquote><h4 id="修改配置-开启sentinel功能" tabindex="-1">修改配置，开启sentinel功能 <a class="header-anchor" href="#修改配置-开启sentinel功能" aria-hidden="true">#</a></h4><p>修改OrderService的application.yml文件，开启Feign的Sentinel功能：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">feign</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">sentinel</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">enabled</span><span style="color:#C9D1D9;">: </span><span style="color:#79C0FF;">true</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;"># 开启feign对sentinel的支持</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="编写失败降级逻辑" tabindex="-1">编写失败降级逻辑 <a class="header-anchor" href="#编写失败降级逻辑" aria-hidden="true">#</a></h4><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p><p>给FeignClient编写失败后的降级逻辑</p><p>①方式一：FallbackClass，无法对远程调用的异常做处理</p><p>②方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p><p>这里我们演示方式二的失败降级处理。</p><p><strong>步骤一</strong>：在feing-api项目中定义类，实现FallbackFactory：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185056.png" alt="image-20210716122403502"></p><p>代码：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FF7B72;">package</span><span style="color:#C9D1D9;"> cn.itcast.feign.clients.fallback;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> cn.itcast.feign.clients.UserClient;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> cn.itcast.feign.pojo.User;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> feign.hystrix.FallbackFactory;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">@</span><span style="color:#FF7B72;">Slf4j</span></span>
<span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">class</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">UserClientFallbackFactory</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">implements</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">FallbackFactory</span><span style="color:#C9D1D9;">&lt;</span><span style="color:#FF7B72;">UserClient</span><span style="color:#C9D1D9;">&gt; {</span></span>
<span class="line"><span style="color:#C9D1D9;">    @</span><span style="color:#FF7B72;">Override</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> UserClient </span><span style="color:#D2A8FF;">create</span><span style="color:#C9D1D9;">(Throwable </span><span style="color:#FFA657;">throwable</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">new</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">UserClient</span><span style="color:#C9D1D9;">() {</span></span>
<span class="line"><span style="color:#C9D1D9;">            @</span><span style="color:#FF7B72;">Override</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> User </span><span style="color:#D2A8FF;">findById</span><span style="color:#C9D1D9;">(Long </span><span style="color:#FFA657;">id</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">                log.</span><span style="color:#D2A8FF;">error</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;查询用户异常&quot;</span><span style="color:#C9D1D9;">, throwable);</span></span>
<span class="line"><span style="color:#C9D1D9;">                </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">new</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">User</span><span style="color:#C9D1D9;">();</span></span>
<span class="line"><span style="color:#C9D1D9;">            }</span></span>
<span class="line"><span style="color:#C9D1D9;">        };</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><strong>步骤二</strong>：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;">@</span><span style="color:#FF7B72;">Bean</span></span>
<span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> UserClientFallbackFactory </span><span style="color:#D2A8FF;">userClientFallbackFactory</span><span style="color:#C9D1D9;">(){</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">new</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">UserClientFallbackFactory</span><span style="color:#C9D1D9;">();</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>步骤三</strong>：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> cn.itcast.feign.clients.fallback.UserClientFallbackFactory;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> cn.itcast.feign.pojo.User;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> org.springframework.cloud.openfeign.FeignClient;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> org.springframework.web.bind.annotation.GetMapping;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> org.springframework.web.bind.annotation.PathVariable;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">@</span><span style="color:#FF7B72;">FeignClient</span><span style="color:#C9D1D9;">(</span><span style="color:#79C0FF;">value</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;userservice&quot;</span><span style="color:#C9D1D9;">, </span><span style="color:#79C0FF;">fallbackFactory</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> UserClientFallbackFactory.class)</span></span>
<span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">interface</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">UserClient</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">    @</span><span style="color:#FF7B72;">GetMapping</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;/user/{id}&quot;</span><span style="color:#C9D1D9;">)</span></span>
<span class="line"><span style="color:#C9D1D9;">    User </span><span style="color:#D2A8FF;">findById</span><span style="color:#C9D1D9;">(@</span><span style="color:#FF7B72;">PathVariable</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;id&quot;</span><span style="color:#C9D1D9;">) Long </span><span style="color:#FFA657;">id</span><span style="color:#C9D1D9;">);</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185105.png" alt="image-20210716123705780"></p><h4 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h4><p>Sentinel支持的雪崩解决方案：</p><ul><li>线程隔离（仓壁模式）</li><li>降级熔断</li></ul><p>Feign整合Sentinel的步骤：</p><ul><li>在application.yml中配置：feign.sentienl.enable=true</li><li>给FeignClient编写FallbackFactory并注册为Bean</li><li>将FallbackFactory配置到FeignClient</li></ul><h3 id="线程隔离-舱壁模式" tabindex="-1">线程隔离（舱壁模式） <a class="header-anchor" href="#线程隔离-舱壁模式" aria-hidden="true">#</a></h3><h4 id="线程隔离的实现方式" tabindex="-1">线程隔离的实现方式 <a class="header-anchor" href="#线程隔离的实现方式" aria-hidden="true">#</a></h4><p>线程隔离有两种方式实现：</p><ul><li><p>线程池隔离</p></li><li><p>信号量隔离（Sentinel默认采用）</p></li></ul><p>如图：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185242.png" alt="image-20210716123036937"></p><p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p><p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p><p>两者的优缺点：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185248.png" alt="image-20210716123240518"></p><h4 id="sentinel的线程隔离" tabindex="-1">sentinel的线程隔离 <a class="header-anchor" href="#sentinel的线程隔离" aria-hidden="true">#</a></h4><p><strong>用法说明</strong>：</p><p>在添加限流规则时，可以选择两种阈值类型：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185307.png" alt="image-20210716123411217"></p><ul><li><p>QPS：就是每秒的请求数，在前面已经演示过</p></li><li><p>线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p></li></ul><h4 id="总结-1" tabindex="-1">总结 <a class="header-anchor" href="#总结-1" aria-hidden="true">#</a></h4><p>线程隔离的两种手段是？</p><ul><li><p>信号量隔离</p></li><li><p>线程池隔离</p></li></ul><p>信号量隔离的特点是？</p><ul><li>基于计数器模式，简单，开销小</li></ul><p>线程池隔离的特点是？</p><ul><li>基于线程池模式，有额外开销，但隔离控制更强</li></ul><h3 id="熔断降级" tabindex="-1">熔断降级 <a class="header-anchor" href="#熔断降级" aria-hidden="true">#</a></h3><blockquote><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p></blockquote><p>断路器控制熔断和放行是通过状态机来完成的：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185541.png" alt="image-20210716130958518"></p><p>状态机包括三个状态：</p><ul><li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li><li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li><li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 <ul><li>请求成功：则切换到closed状态</li><li>请求失败：则切换到open状态</li></ul></li></ul><p>断路器熔断策略有三种：慢调用、异常比例、异常数</p><h4 id="慢调用" tabindex="-1">慢调用 <a class="header-anchor" href="#慢调用" aria-hidden="true">#</a></h4><p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p><p>例如：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185548.png" alt="image-20210716145934347"></p><p>解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。</p><h4 id="异常比例、异常数" tabindex="-1">异常比例、异常数 <a class="header-anchor" href="#异常比例、异常数" aria-hidden="true">#</a></h4><p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p><p>例如，一个异常比例设置：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185641.png" alt="image-20210716131430682"></p><p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。</p><p>一个异常数设置：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113185639.png" alt="image-20210716131522912"></p><p>解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。</p><h2 id="授权规则" tabindex="-1">授权规则 <a class="header-anchor" href="#授权规则" aria-hidden="true">#</a></h2><blockquote><p>授权规则可以对请求方来源做判断和控制。</p></blockquote><h3 id="授权规则-1" tabindex="-1">授权规则 <a class="header-anchor" href="#授权规则-1" aria-hidden="true">#</a></h3><h4 id="基本规则" tabindex="-1">基本规则 <a class="header-anchor" href="#基本规则" aria-hidden="true">#</a></h4><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p><ul><li><p>白名单：来源（origin）在白名单内的调用者允许访问</p></li><li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p></li></ul><p>点击左侧菜单的授权，可以看到授权规则：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190000.png" alt="image-20210716152010750"></p><ul><li orderId=""><p>资源名：就是受保护的资源，例如/order/</p></li><li><p>流控应用：是来源者的名单，</p><ul><li>如果是勾选白名单，则名单中的来源被许可访问。</li><li>如果是勾选黑名单，则名单中的来源被禁止访问。</li></ul></li></ul><p>比如：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190001.png" alt="image-20210716152349191"></p><p>我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p><h4 id="如何获取origin" tabindex="-1">如何获取origin <a class="header-anchor" href="#如何获取origin" aria-hidden="true">#</a></h4><p>Sentinel是通过RequestOriginParser这个接口的parseOrigin来获取请求的来源的。</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">interface</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">RequestOriginParser</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#8B949E;">    /**</span></span>
<span class="line"><span style="color:#8B949E;">     * 从请求request对象中获取origin，获取方式自定义</span></span>
<span class="line"><span style="color:#8B949E;">     */</span></span>
<span class="line"><span style="color:#C9D1D9;">    String </span><span style="color:#D2A8FF;">parseOrigin</span><span style="color:#C9D1D9;">(HttpServletRequest </span><span style="color:#FFA657;">request</span><span style="color:#C9D1D9;">);</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。</p><p>默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。</p><p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的origin</strong>。</p><p>例如order-service服务中，我们定义一个RequestOriginParser的实现类：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FF7B72;">package</span><span style="color:#C9D1D9;"> cn.itcast.order.sentinel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> org.springframework.stereotype.Component;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> org.springframework.util.StringUtils;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> javax.servlet.http.HttpServletRequest;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">@</span><span style="color:#FF7B72;">Component</span></span>
<span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">class</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">HeaderOriginParser</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">implements</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">RequestOriginParser</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">    @</span><span style="color:#FF7B72;">Override</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> String </span><span style="color:#D2A8FF;">parseOrigin</span><span style="color:#C9D1D9;">(HttpServletRequest </span><span style="color:#FFA657;">request</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#8B949E;">// 1.获取请求头</span></span>
<span class="line"><span style="color:#C9D1D9;">        String</span><span style="color:#FFA657;"> </span><span style="color:#C9D1D9;">origin</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> request.</span><span style="color:#D2A8FF;">getHeader</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;origin&quot;</span><span style="color:#C9D1D9;">);</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#8B949E;">// 2.非空判断</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (StringUtils.</span><span style="color:#D2A8FF;">isEmpty</span><span style="color:#C9D1D9;">(origin)) {</span></span>
<span class="line"><span style="color:#C9D1D9;">            origin </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;blank&quot;</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">        }</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> origin;</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>我们会尝试从request-header中获取origin值。</p><h4 id="给网关添加请求头" tabindex="-1">给网关添加请求头 <a class="header-anchor" href="#给网关添加请求头" aria-hidden="true">#</a></h4><p>既然获取请求origin的方式是从reques-header中获取origin值，我们必须让<strong>所有从gateway路由到微服务的请求都带上origin头</strong>。</p><p>这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。</p><p>修改gateway服务中的application.yml，添加一个defaultFilter：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">gateway</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">default-filters</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">        - </span><span style="color:#A5D6FF;">AddRequestHeader=origin,gateway</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">routes</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">       </span><span style="color:#8B949E;"># ...略</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这样，从gateway路由的所有请求都会带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。</p><h4 id="配置授权规则" tabindex="-1">配置授权规则 <a class="header-anchor" href="#配置授权规则" aria-hidden="true">#</a></h4><p>接下来，我们添加一个授权规则，放行origin值为gateway的请求。</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190738.png" alt="image-20210716153250134"></p><p>配置如下：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190005.png" alt="image-20210716153301069"></p><p>现在，我们直接跳过网关，访问order-service服务：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190008.png" alt="image-20210716153348396"></p><p>通过网关访问：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190010.png" alt="image-20210716153434095"></p><h3 id="自定义异常结果" tabindex="-1">自定义异常结果 <a class="header-anchor" href="#自定义异常结果" aria-hidden="true">#</a></h3><blockquote><p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p></blockquote><h4 id="异常类型" tabindex="-1">异常类型 <a class="header-anchor" href="#异常类型" aria-hidden="true">#</a></h4><p>而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">interface</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">BlockExceptionHandler</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#8B949E;">    /**</span></span>
<span class="line"><span style="color:#8B949E;">     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span>
<span class="line"><span style="color:#8B949E;">     */</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">handle</span><span style="color:#C9D1D9;">(HttpServletRequest </span><span style="color:#FFA657;">request</span><span style="color:#C9D1D9;">, HttpServletResponse </span><span style="color:#FFA657;">response</span><span style="color:#C9D1D9;">, BlockException </span><span style="color:#FFA657;">e</span><span style="color:#C9D1D9;">) </span><span style="color:#FF7B72;">throws</span><span style="color:#C9D1D9;"> Exception;</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这个方法有三个参数：</p><ul><li>HttpServletRequest request：request对象</li><li>HttpServletResponse response：response对象</li><li>BlockException e：被sentinel拦截时抛出的异常</li></ul><p>这里的BlockException包含多个不同的子类：</p><table><thead><tr><th><strong>异常</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>FlowException</td><td>限流异常</td></tr><tr><td>ParamFlowException</td><td>热点参数限流的异常</td></tr><tr><td>DegradeException</td><td>降级异常</td></tr><tr><td>AuthorityException</td><td>授权规则异常</td></tr><tr><td>SystemBlockException</td><td>系统规则异常</td></tr></tbody></table><h4 id="自定义异常处理" tabindex="-1">自定义异常处理 <a class="header-anchor" href="#自定义异常处理" aria-hidden="true">#</a></h4><p>下面，我们就在order-service定义一个自定义异常处理类：</p><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FF7B72;">package</span><span style="color:#C9D1D9;"> cn.itcast.order.sentinel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.slots.block.BlockException;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.slots.block.flow.FlowException;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> org.springframework.stereotype.Component;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> javax.servlet.http.HttpServletRequest;</span></span>
<span class="line"><span style="color:#FF7B72;">import</span><span style="color:#C9D1D9;"> javax.servlet.http.HttpServletResponse;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">@</span><span style="color:#FF7B72;">Component</span></span>
<span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">class</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">SentinelExceptionHandler</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">implements</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">BlockExceptionHandler</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">    @</span><span style="color:#FF7B72;">Override</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">handle</span><span style="color:#C9D1D9;">(HttpServletRequest </span><span style="color:#FFA657;">request</span><span style="color:#C9D1D9;">, HttpServletResponse </span><span style="color:#FFA657;">response</span><span style="color:#C9D1D9;">, BlockException </span><span style="color:#FFA657;">e</span><span style="color:#C9D1D9;">) </span><span style="color:#FF7B72;">throws</span><span style="color:#C9D1D9;"> Exception {</span></span>
<span class="line"><span style="color:#C9D1D9;">        String</span><span style="color:#FFA657;"> </span><span style="color:#C9D1D9;">msg</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;未知异常&quot;</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">int</span><span style="color:#FFA657;"> </span><span style="color:#C9D1D9;">status</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">429</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (e </span><span style="color:#FF7B72;">instanceof</span><span style="color:#C9D1D9;"> FlowException) {</span></span>
<span class="line"><span style="color:#C9D1D9;">            msg </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;请求被限流了&quot;</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">        } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (e </span><span style="color:#FF7B72;">instanceof</span><span style="color:#C9D1D9;"> ParamFlowException) {</span></span>
<span class="line"><span style="color:#C9D1D9;">            msg </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;请求被热点参数限流&quot;</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">        } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (e </span><span style="color:#FF7B72;">instanceof</span><span style="color:#C9D1D9;"> DegradeException) {</span></span>
<span class="line"><span style="color:#C9D1D9;">            msg </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;请求被降级了&quot;</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">        } </span><span style="color:#FF7B72;">else</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">if</span><span style="color:#C9D1D9;"> (e </span><span style="color:#FF7B72;">instanceof</span><span style="color:#C9D1D9;"> AuthorityException) {</span></span>
<span class="line"><span style="color:#C9D1D9;">            msg </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;没有权限访问&quot;</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">            status </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">401</span><span style="color:#C9D1D9;">;</span></span>
<span class="line"><span style="color:#C9D1D9;">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C9D1D9;">        response.</span><span style="color:#D2A8FF;">setContentType</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;application/json;charset=utf-8&quot;</span><span style="color:#C9D1D9;">);</span></span>
<span class="line"><span style="color:#C9D1D9;">        response.</span><span style="color:#D2A8FF;">setStatus</span><span style="color:#C9D1D9;">(status);</span></span>
<span class="line"><span style="color:#C9D1D9;">        response.</span><span style="color:#D2A8FF;">getWriter</span><span style="color:#C9D1D9;">().</span><span style="color:#D2A8FF;">println</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;{</span><span style="color:#79C0FF;">\&quot;</span><span style="color:#A5D6FF;">msg</span><span style="color:#79C0FF;">\&quot;</span><span style="color:#A5D6FF;">: &quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">+</span><span style="color:#C9D1D9;"> msg </span><span style="color:#FF7B72;">+</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;, </span><span style="color:#79C0FF;">\&quot;</span><span style="color:#A5D6FF;">status</span><span style="color:#79C0FF;">\&quot;</span><span style="color:#A5D6FF;">: &quot;</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">+</span><span style="color:#C9D1D9;"> status </span><span style="color:#FF7B72;">+</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">&quot;}&quot;</span><span style="color:#C9D1D9;">);</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>重启测试，在不同场景下，会返回不同的异常消息.</p><p>限流：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190104.png" alt="image-20210716153938887"></p><p>授权拦截时：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113190108.png" alt="image-20210716154012736"></p><h2 id="规则持久化" tabindex="-1">规则持久化 <a class="header-anchor" href="#规则持久化" aria-hidden="true">#</a></h2><h3 id="源码改造" tabindex="-1">源码改造 <a class="header-anchor" href="#源码改造" aria-hidden="true">#</a></h3><p>可以使用我改造好的源码<a href="https://github.com/linzili/sentinel-gateway-nacos" target="_blank" rel="noreferrer">github</a> 或手动修改</p><ol><li><p>打开sentinel项目 <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113181835.png" alt=""></p></li><li><p>在sentinel-dashboard源码的pom文件中，nacos的依赖默认的scope是test，只能在测试时使用，这里要去除：</p></li></ol><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113181925.png" alt=""></p><p>将sentinel-datasource-nacos依赖的scope去掉：</p><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;com.alibaba.csp&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;sentinel-datasource-nacos&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="3"><li>添加nacos支持</li></ol><p>在sentinel-dashboard的test包下，已经编写了对nacos的支持，我们需要将其拷贝到main下。</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182019.png" alt=""></p><ol start="4"><li>修改nacos地址</li></ol><p>然后，还需要修改测试代码中的NacosConfig类： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182039.png" alt=""> 修改其中的nacos地址，让其读取application.properties中的配置： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182047.png" alt=""></p><p>在sentinel-dashboard的application.properties中添加nacos地址配置： <code>nacos.addr=localhost:8848</code></p><ol start="5"><li>配置nacos数据源</li></ol><p>另外，还需要修改com.alibaba.csp.sentinel.dashboard.controller.v2包下的FlowControllerV2类：</p><p><img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182118.png" alt=""></p><p>让我们添加的Nacos数据源生效： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182125.png" alt=""></p><ol start="6"><li>修改前端页面 接下来，还要修改前端页面，添加一个支持nacos的菜单。</li></ol><p>修改<code>src/main/webapp/resources/app/scripts/directives/sidebar/</code>目录下的<code>sidebar.html</code>文件： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182136.png" alt=""> 将其中的这部分注释打开： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182215.png" alt=""> 修改其中的文本： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182228.png" alt=""></p><ol start="7"><li>重新编译、打包项目</li></ol><p>运行IDEA中的maven插件，编译和打包修改好的Sentinel-Dashboard： <img src="https://cdn.azhiyuan.com.cn/markdown/img/2023/01/13/20230113182240.png" alt=""></p><ol start="8"><li>启动</li></ol><p>启动方式跟官方一样：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FFA657;">java</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">-jar</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">sentinel-dashboard.jar</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果要修改nacos地址，需要添加参数：</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#FFA657;">java</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">-jar</span><span style="color:#C9D1D9;"> </span><span style="color:#79C0FF;">-Dnacos.addr=localhost:8848</span><span style="color:#C9D1D9;"> </span><span style="color:#A5D6FF;">sentinel-dashboard.jar</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="服务配置" tabindex="-1">服务配置 <a class="header-anchor" href="#服务配置" aria-hidden="true">#</a></h3><ol><li>引入依赖</li></ol><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;com.alibaba.csp&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;sentinel-datasource-nacos&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>配置nacos地址</li></ol><p>在service中的<code>application.yml</code>文件配置nacos地址及监听的配置信息：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">sentinel</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">datasource</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#7EE787;">flow</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#7EE787;">nacos</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">server-addr</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">localhost:8848</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;"># nacos地址</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">dataId</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">servicename-flow-rules</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">DEFAULT_GROUP</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">rule-type</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">flow</span><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;"># 还可以是：degrade、authority、param-flow</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div></div></main><!--[--><!--]--><footer class="VPDocFooter" data-v-22d94e81 data-v-d057f2bd><div class="edit-info" data-v-d057f2bd><!----><div class="last-updated" data-v-d057f2bd><p class="VPLastUpdated" data-v-d057f2bd data-v-8698a6d5>Last updated: <time datetime="2023-01-13T11:10:25.000Z" data-v-8698a6d5></time></p></div></div><div class="prev-next" data-v-d057f2bd><div class="pager" data-v-d057f2bd><a class="pager-link prev" href="/lindocs/spring/springcloud/nacos.html" data-v-d057f2bd><span class="desc" data-v-d057f2bd>Previous page</span><span class="title" data-v-d057f2bd>nacos</span></a></div><div class="has-prev pager" data-v-d057f2bd><a class="pager-link next" href="/lindocs/spring/springcloud/springcloudgateway.html" data-v-d057f2bd><span class="desc" data-v-d057f2bd>Next page</span><span class="title" data-v-d057f2bd>gateway</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-2855b47a data-v-d7033f51><div class="container" data-v-d7033f51><p class="message" data-v-d7033f51>Released under the MIT License.</p><p class="copyright" data-v-d7033f51>Copyright © 2021-present Lin ZiLi</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"database_mysql_mysql-base.md\":\"d24b2cdb\",\"frontend_js_index.md\":\"ebb37d54\",\"frontend_vue_api_general.md\":\"012c5b96\",\"frontend_vue_code-standard.md\":\"ef182af4\",\"frontend_vue_quick-start.md\":\"f0f906c7\",\"index.md\":\"09d43ddb\",\"java_gradle.md\":\"b99aba8d\",\"java_docker.md\":\"ab5c8a17\",\"java_spring_mybatisplus.md\":\"c4a2692a\",\"java_spring_ssm整合.md\":\"763e455d\",\"java_spring_springboot.md\":\"642486f6\",\"spring_index.md\":\"7cc7aa85\",\"spring_springboot_springboot.md\":\"a954cba4\",\"spring_springcloud_springcloud.md\":\"0f4ab88b\",\"java_spring_spring.md\":\"36b7be67\",\"network_linux.md\":\"3d1176e2\",\"kotlin_index.md\":\"d84c5557\",\"database_mysql_navicat.md\":\"7f0db14b\",\"java_spring_springmvc.md\":\"cbc19572\",\"spring_springcloud_nacos.md\":\"51b31f65\",\"spring_springcloud_openfeign.md\":\"1b961d59\",\"spring_springcloud_sentinel.md\":\"4f75d99a\",\"network_ipv6.md\":\"7149b75d\",\"java_spring_springsecurityjwt.md\":\"fb139c8f\",\"java_java-base.md\":\"344278f1\",\"spring_springboot_rabbitmq.md\":\"0d8fcd44\",\"spring_springcloud_springcloudgateway.md\":\"6c79c7b8\",\"java_spring_mybatis.md\":\"2a9d30ea\"}")</script>
    <script type="module" async src="/lindocs/assets/app.9e1597b0.js"></script>
    
  </body>
</html>