import{_ as s,c as n,o as a,a as l}from"./app.10d45b38.js";const u=JSON.parse('{"title":"Spring Cloud Gateway","description":"","frontmatter":{},"headers":[{"level":2,"title":"快速入门","slug":"快速入门","link":"#快速入门","children":[]},{"level":2,"title":"CORS跨域","slug":"cors跨域","link":"#cors跨域","children":[]},{"level":2,"title":"整合 sentinel 限流","slug":"整合-sentinel-限流","link":"#整合-sentinel-限流","children":[{"level":3,"title":"持久化","slug":"持久化","link":"#持久化","children":[]}]}],"relativePath":"spring/springcloud/springcloudgateway.md","lastUpdated":1673607877000}'),p={name:"spring/springcloud/springcloudgateway.md"},e=l(`<h1 id="spring-cloud-gateway" tabindex="-1">Spring Cloud Gateway <a class="header-anchor" href="#spring-cloud-gateway" aria-hidden="true">#</a></h1><p>SpringCloud Gateway 是 Spring Cloud 的一个全新项目，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。</p><h2 id="快速入门" tabindex="-1">快速入门 <a class="header-anchor" href="#快速入门" aria-hidden="true">#</a></h2><ol><li>添加依赖</li></ol><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;org.springframework.cloud&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;spring-cloud-starter-gateway&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>配置路由</li></ol><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">gateway</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#8B949E;"># 路由规则</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">routes</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#8B949E;"># 服务名称</span></span>
<span class="line"><span style="color:#C9D1D9;">        - </span><span style="color:#7EE787;">id</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">system-service</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#7EE787;">uri</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">lb://system-service</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#8B949E;"># 断言规则</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#7EE787;">predicates</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">            - </span><span style="color:#A5D6FF;">Path=/system/**</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#8B949E;"># 过滤前缀</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#7EE787;">filters</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">            - </span><span style="color:#A5D6FF;">StripPrefix=1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>在springcloud 2021以上版本移除了内置的ribbon模块,如果使用<code>gateway</code> + 注册中心进行转发,需要手动添加<code>LoadBalance</code>依赖</p></div><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;">&lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;org.springframework.cloud&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">    &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;spring-cloud-loadbalance&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">&lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="cors跨域" tabindex="-1">CORS跨域 <a class="header-anchor" href="#cors跨域" aria-hidden="true">#</a></h2><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">gateway</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">globalcors</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#7EE787;">add-to-simple-url-handler-mapping</span><span style="color:#C9D1D9;">: </span><span style="color:#79C0FF;">true</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#7EE787;">corsConfigurations</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">          </span><span style="color:#A5D6FF;">&#39;[/**]&#39;</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">allowedHeaders</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">&quot;*&quot;</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">allowedOrigins</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">&quot;*&quot;</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#7EE787;">allowedMethods</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">              - </span><span style="color:#A5D6FF;">GET</span></span>
<span class="line"><span style="color:#C9D1D9;">              - </span><span style="color:#A5D6FF;">POST</span></span>
<span class="line"><span style="color:#C9D1D9;">              - </span><span style="color:#A5D6FF;">DELETE</span></span>
<span class="line"><span style="color:#C9D1D9;">              - </span><span style="color:#A5D6FF;">PUT</span></span>
<span class="line"><span style="color:#C9D1D9;">              - </span><span style="color:#A5D6FF;">OPTION</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="整合-sentinel-限流" tabindex="-1">整合 sentinel 限流 <a class="header-anchor" href="#整合-sentinel-限流" aria-hidden="true">#</a></h2><ol><li>添加依赖</li></ol><div class="language-xml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;"> </span><span style="color:#8B949E;">&lt;!--假如网关层面进行限流,添加如下依赖--&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">  &lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">      &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;com.alibaba.cloud&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">      &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;spring-cloud-starter-alibaba-sentinel&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">  &lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">  &lt;</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">      &lt;</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;com.alibaba.cloud&lt;/</span><span style="color:#7EE787;">groupId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">      &lt;</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;spring-cloud-alibaba-sentinel-gateway&lt;/</span><span style="color:#7EE787;">artifactId</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"><span style="color:#C9D1D9;">  &lt;/</span><span style="color:#7EE787;">dependency</span><span style="color:#C9D1D9;">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>配置sentinel控制台地址</li></ol><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#7EE787;">spring</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">  </span><span style="color:#7EE787;">cloud</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#7EE787;">sentinel</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">      </span><span style="color:#7EE787;">transport</span><span style="color:#C9D1D9;">:</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#7EE787;">dashboard</span><span style="color:#C9D1D9;">: </span><span style="color:#A5D6FF;">127.0.0.1:8080</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li><p>对网关发送请求,然后到控制台查看</p></li><li><p>自定义限流、降级规则</p></li></ol><div class="language-java line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki github-dark"><code><span class="line"><span style="color:#C9D1D9;">@</span><span style="color:#FF7B72;">Component</span></span>
<span class="line"><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">class</span><span style="color:#C9D1D9;"> </span><span style="color:#FFA657;">GatewayConfig</span><span style="color:#C9D1D9;"> {</span></span>
<span class="line"><span style="color:#C9D1D9;">    @</span><span style="color:#FF7B72;">PostConstruct</span></span>
<span class="line"><span style="color:#C9D1D9;">    </span><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">void</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">init</span><span style="color:#C9D1D9;">() {</span></span>
<span class="line"><span style="color:#C9D1D9;">        BlockRequestHandler</span><span style="color:#FFA657;"> </span><span style="color:#C9D1D9;">blockRequestHandler</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">new</span><span style="color:#C9D1D9;"> </span><span style="color:#D2A8FF;">BlockRequestHandler</span><span style="color:#C9D1D9;">() {</span></span>
<span class="line"><span style="color:#C9D1D9;">            @</span><span style="color:#FF7B72;">Override</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#8B949E;">// 编写自定义降级响应</span></span>
<span class="line"><span style="color:#C9D1D9;">            </span><span style="color:#FF7B72;">public</span><span style="color:#C9D1D9;"> Mono&lt;</span><span style="color:#FF7B72;">ServerResponse</span><span style="color:#C9D1D9;">&gt; </span><span style="color:#D2A8FF;">handleRequest</span><span style="color:#C9D1D9;">(ServerWebExchange </span><span style="color:#FFA657;">exchange</span><span style="color:#C9D1D9;">, Throwable </span><span style="color:#FFA657;">t</span><span style="color:#C9D1D9;">) {</span></span>
<span class="line"><span style="color:#C9D1D9;">                Map</span><span style="color:#FFA657;">&lt;</span><span style="color:#FF7B72;">String</span><span style="color:#FFA657;">, </span><span style="color:#FF7B72;">Object</span><span style="color:#FFA657;">&gt; </span><span style="color:#C9D1D9;">map</span><span style="color:#FFA657;"> </span><span style="color:#FF7B72;">=</span><span style="color:#C9D1D9;"> </span><span style="color:#FF7B72;">new</span><span style="color:#C9D1D9;"> HashMap&lt;&gt;();</span></span>
<span class="line"><span style="color:#C9D1D9;">                map.</span><span style="color:#D2A8FF;">put</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;code&quot;</span><span style="color:#C9D1D9;">, HttpStatus.TOO_MANY_REQUESTS.</span><span style="color:#D2A8FF;">value</span><span style="color:#C9D1D9;">());</span></span>
<span class="line"><span style="color:#C9D1D9;">                map.</span><span style="color:#D2A8FF;">put</span><span style="color:#C9D1D9;">(</span><span style="color:#A5D6FF;">&quot;message&quot;</span><span style="color:#C9D1D9;">, </span><span style="color:#A5D6FF;">&quot;限流了&quot;</span><span style="color:#C9D1D9;">);</span></span>
<span class="line"><span style="color:#C9D1D9;">                </span><span style="color:#FF7B72;">return</span><span style="color:#C9D1D9;"> ServerResponse.</span><span style="color:#D2A8FF;">status</span><span style="color:#C9D1D9;">(HttpStatus.OK).</span><span style="color:#D2A8FF;">contentType</span><span style="color:#C9D1D9;">(MediaType.APPLICATION_JSON)</span></span>
<span class="line"><span style="color:#C9D1D9;">                        .</span><span style="color:#D2A8FF;">body</span><span style="color:#C9D1D9;">(BodyInserters.</span><span style="color:#D2A8FF;">fromValue</span><span style="color:#C9D1D9;">(map));</span></span>
<span class="line"><span style="color:#C9D1D9;">            }</span></span>
<span class="line"><span style="color:#C9D1D9;">        };</span></span>
<span class="line"><span style="color:#C9D1D9;">        </span><span style="color:#8B949E;">// 设置handler到gateway</span></span>
<span class="line"><span style="color:#C9D1D9;">        GatewayCallbackManager.</span><span style="color:#D2A8FF;">setBlockHandler</span><span style="color:#C9D1D9;">(blockRequestHandler);</span></span>
<span class="line"><span style="color:#C9D1D9;">    }</span></span>
<span class="line"><span style="color:#C9D1D9;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="持久化" tabindex="-1">持久化 <a class="header-anchor" href="#持久化" aria-hidden="true">#</a></h3><p>想要让gateway持久化可以参考我修改后的源码<a href="https://github.com/linzili/sentinel-gateway-nacos" target="_blank" rel="noreferrer">github</a>,过于复杂不在此赘述.</p>`,20),o=[e];function r(c,t,i,D,y,b){return a(),n("div",null,o)}const C=s(p,[["render",r]]);export{u as __pageData,C as default};
